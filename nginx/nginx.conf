worker_processes auto;
events { worker_connections 1024; }

http {
  # Rate limit zone por IP
  # 5 req/seg por IP, con burst (cola) de 10
  limit_req_zone $binary_remote_addr zone=req_per_ip:10m rate=5r/s;

  upstream api_upstream {
    server api:8000;  # Docker DNS
  }

  server {
    listen 80;

    location / {
      # ðŸ”’ Throttling / Rate Limiting
      limit_req zone=req_per_ip burst=10 nodelay;

      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_pass http://api_upstream;
      proxy_connect_timeout 5s;
      proxy_read_timeout 60s;
      proxy_send_timeout 60s;
    }
  }
}
